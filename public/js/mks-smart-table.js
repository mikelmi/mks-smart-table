!function(e,t){"use strict";e.module("smart-table",[]).run(["$templateCache",function(e){e.put("template/smart-table/pagination.html",'<nav ng-if="numPages && pages.length >= 2"><ul class="pagination"><li ng-repeat="page in pages" ng-class="{active: page==currentPage}"><a href="javascript: void(0);" ng-click="selectPage(page)">{{page}}</a></li></ul></nav>')}]),e.module("smart-table").constant("stConfig",{pagination:{template:"template/smart-table/pagination.html",itemsByPage:10,displayedPages:5},search:{delay:400,inputEvent:"input"},select:{mode:"single",selectedClass:"st-selected"},sort:{ascentClass:"st-sort-ascent",descentClass:"st-sort-descent",descendingFirst:!1,skipNatural:!1,delay:300},pipe:{delay:100}}),e.module("smart-table").controller("stTableController",["$scope","$parse","$filter","$attrs",function(n,a,s,i){function r(e){return e?[].concat(e):[]}function c(){v=r(o(n)),b===!0&&y.pipe()}function l(e,t){if(t.indexOf(".")!=-1){var n=t.split("."),s=n.pop(),i=n.join("."),r=a(i)(e);delete r[s],0==Object.keys(r).length&&l(e,i)}else delete e[t]}var o,u,d,p=i.stTable,g=a(p),f=g.assign,h=s("orderBy"),m=s("filter"),v=r(g(n)),S={sort:{},search:{},pagination:{start:0,totalItemCount:0}},b=!0,y=this;i.stSafeSrc&&(o=a(i.stSafeSrc),n.$watch(function(){var e=o(n);return e&&e.length?e[0]:t},function(e,t){e!==t&&c()}),n.$watch(function(){var e=o(n);return e?e.length:0},function(e,t){e!==v.length&&c()}),n.$watch(function(){return o(n)},function(e,t){e!==t&&(S.pagination.start=0,c())})),this.sortBy=function(t,n){return S.sort.predicate=t,S.sort.reverse=n===!0,e.isFunction(t)?S.sort.functionName=t.name:delete S.sort.functionName,S.pagination.start=0,this.pipe()},this.search=function(t,n){var s=S.search.predicateObject||{},i=n?n:"$";return t=e.isString(t)?t.trim():t,a(i).assign(s,t),t||l(s,i),S.search.predicateObject=s,S.pagination.start=0,this.pipe()},this.pipe=function(){var e,a=S.pagination;u=S.search.predicateObject?m(v,S.search.predicateObject):v,S.sort.predicate&&(u=h(u,S.sort.predicate,S.sort.reverse)),a.totalItemCount=u.length,a.number!==t&&(a.numberOfPages=u.length>0?Math.ceil(u.length/a.number):1,a.start=a.start>=u.length?(a.numberOfPages-1)*a.number:a.start,e=u.slice(a.start,a.start+parseInt(a.number))),f(n,e||u)},this.select=function(e,a){var s=r(g(n)),i=s.indexOf(e);i!==-1&&("single"===a?(e.isSelected=e.isSelected!==!0,d&&(d.isSelected=!1),d=e.isSelected===!0?e:t):s[i].isSelected=!s[i].isSelected)},this.slice=function(e,t){return S.pagination.start=e,S.pagination.number=t,this.pipe()},this.tableState=function(){return S},this.getFilteredCollection=function(){return u||v},this.setFilterFunction=function(e){m=s(e)},this.setSortFunction=function(e){h=s(e)},this.preventPipeOnWatch=function(){b=!1}}]).directive("stTable",function(){return{restrict:"A",controller:"stTableController",link:function(e,t,n,a){n.stSetFilter&&a.setFilterFunction(n.stSetFilter),n.stSetSort&&a.setSortFunction(n.stSetSort)}}}),e.module("smart-table").directive("stSearch",["stConfig","$timeout","$parse",function(e,t,n){return{require:"^stTable",link:function(a,s,i,r){var c=r,l=null,o=i.stDelay||e.search.delay,u=i.stInputEvent||e.search.inputEvent;i.$observe("stSearch",function(e,t){var n=s[0].value;e!==t&&n&&(r.tableState().search={},c.search(n,e))}),a.$watch(function(){return r.tableState().search},function(e,t){var a=i.stSearch||"$";e.predicateObject&&n(a)(e.predicateObject)!==s[0].value&&(s[0].value=n(a)(e.predicateObject)||"")},!0),s.bind(u,function(e){e=e.originalEvent||e,null!==l&&t.cancel(l),l=t(function(){c.search(e.target.value,i.stSearch||""),l=null},o)})}}}]),e.module("smart-table").directive("stSelectRow",["stConfig",function(e){return{restrict:"A",require:"^stTable",scope:{row:"=stSelectRow"},link:function(t,n,a,s){var i=a.stSelectMode||e.select.mode;n.bind("click",function(){t.$apply(function(){s.select(t.row,i)})}),t.$watch("row.isSelected",function(t){t===!0?n.addClass(e.select.selectedClass):n.removeClass(e.select.selectedClass)})}}}]),e.module("smart-table").directive("stSort",["stConfig","$parse","$timeout",function(n,a,s){return{restrict:"A",require:"^stTable",link:function(i,r,c,l){function o(){S?g=0===g?2:g-1:g++;var t;d=e.isFunction(p(i))||e.isArray(p(i))?p(i):c.stSort,g%3===0&&!!v!=!0?(g=0,l.tableState().sort={},l.tableState().pagination.start=0,t=l.pipe.bind(l)):t=l.sortBy.bind(l,d,g%2===0),null!==b&&s.cancel(b),y<0?t():b=s(t,y)}var u,d=c.stSort,p=a(d),g=0,f=c.stClassAscent||n.sort.ascentClass,h=c.stClassDescent||n.sort.descentClass,m=[f,h],v=c.stSkipNatural!==t?c.stSkipNatural:n.sort.skipNatural,S=c.stDescendingFirst!==t?c.stDescendingFirst:n.sort.descendingFirst,b=null,y=c.stDelay||n.sort.delay;c.stSortDefault&&(u=i.$eval(c.stSortDefault)!==t?i.$eval(c.stSortDefault):c.stSortDefault),r.bind("click",function(){d&&i.$apply(o)}),u&&(g="reverse"===u?1:0,o()),i.$watch(function(){return l.tableState().sort},function(e){e.predicate!==d?(g=0,r.removeClass(f).removeClass(h)):(g=e.reverse===!0?2:1,r.removeClass(m[g%2]).addClass(m[g-1]))},!0)}}}]),e.module("smart-table").directive("stPagination",["stConfig",function(e){return{restrict:"EA",require:"^stTable",scope:{stItemsByPage:"=?",stDisplayedPages:"=?",stPageChange:"&"},templateUrl:function(t,n){return n.stTemplate?n.stTemplate:e.pagination.template},link:function(t,n,a,s){function i(){var e,n,a=s.tableState().pagination,i=1,r=t.currentPage;for(t.totalItemCount=a.totalItemCount,t.currentPage=Math.floor(a.start/a.number)+1,i=Math.max(i,t.currentPage-Math.abs(Math.floor(t.stDisplayedPages/2))),e=i+t.stDisplayedPages,e>a.numberOfPages&&(e=a.numberOfPages+1,i=Math.max(1,e-t.stDisplayedPages)),t.pages=[],t.numPages=a.numberOfPages,n=i;n<e;n++)t.pages.push(n);r!==t.currentPage&&t.stPageChange({newPage:t.currentPage})}t.stItemsByPage=t.stItemsByPage?+t.stItemsByPage:e.pagination.itemsByPage,t.stDisplayedPages=t.stDisplayedPages?+t.stDisplayedPages:e.pagination.displayedPages,t.currentPage=1,t.pages=[],t.$watch(function(){return s.tableState().pagination},i,!0),t.$watch("stItemsByPage",function(e,n){e!==n&&t.selectPage(1)}),t.$watch("stDisplayedPages",i),t.selectPage=function(e){e>0&&e<=t.numPages&&s.slice((e-1)*t.stItemsByPage,t.stItemsByPage)},s.tableState().pagination.number||s.slice(0,t.stItemsByPage)}}}]),e.module("smart-table").directive("stPipe",["stConfig","$timeout",function(t,n){return{require:"stTable",scope:{stPipe:"="},link:{pre:function(a,s,i,r){var c=null;e.isFunction(a.stPipe)&&(r.preventPipeOnWatch(),r.pipe=function(){return null!==c&&n.cancel(c),c=n(function(){a.stPipe(r.tableState(),r)},t.pipe.delay)})},post:function(e,t,n,a){a.pipe()}}}}])}(angular),function(){var e=angular.module("mks-smart-table",["smart-table"]);e.run(["$templateCache",function(e){e.put("template/smart-table/pagination.html",'<nav ng-if="numPages && pages.length >= 2"><ul class="pagination"><li><a href="javascript: void(0);" ng-click="selectPage(1)"><span>&laquo;</span></a></li><li ng-repeat="page in pages" ng-class="{active: page==currentPage}"><a href="javascript: void(0);" ng-click="selectPage(page)">{{page}}</a></li><li><a href="javascript: void(0);" ng-click="selectPage(numPages)"><span>&raquo;</span></a></li></ul></nav>')}]),e.controller("TableCtrl",["$http","$q","$scope","$filter",function(e,t,n,a){function s(n,a,s,i){l&&l.resolve("cancel"),l=t.defer();var r={start:a,number:s};i.sort&&(r.sort=i.sort),i.search&&i.search.predicateObject&&(r.search=i.search.predicateObject);var c={method:"GET",url:n+"?"+jQuery.param(r),headers:{"X-Requested-With":"XMLHttpRequest"},timeout:l.promise};return e(c)}function i(e){var t=c.rows.indexOf(e);t!==-1&&(c.rows.splice(t,1),c.total>0&&c.total--,e.isSelected&&c.hasSelected>0&&c.hasSelected--)}function r(e){return jQuery.map(e,function(e){return e[c.idKey]})}this.rows=[],this.url=null,this.start=0,this.end=0,this.total=0,this.hasSelected=0,this.idKey="id";var c=this,l=null;this.init=function(e,t){this.url=e,t&&(this.idKey=t)},this.pipeServer=function(e){if(c.url){c.isLoading=!0;var t=e.pagination,n=t.start||0,a=t.number||10;s(c.url,n,a,e).success(function(t){c.rows=t.data,e.pagination.numberOfPages=t.pages;var n=e.pagination.start;c.end=n+c.rows.length,c.rows.length>0&&n++,c.start=n,c.total=t.total,c.hasSelected=0,c.isLoading=!1}).error(function(){c.isLoading=!1})}},this.removeRow=function(t,n,a){return!(a&&!confirm(a))&&(n?(t.isLoading=!0,e.post(n).then(function(){t.isLoading=!1,i(t)},function(){t.isLoading=!1}),!1):(i(t),!1))},this.getSelected=function(){return a("filter")(this.rows,{isSelected:!0})},this.removeSelected=function(t,n){if(n&&!confirm(n))return!1;var a=this.getSelected();return!!a.length&&(t?(c.isLoading=!0,void e.post(t,{id:r(a)}).then(function(){angular.forEach(a,function(e){i(e)}),c.isLoading=!1},function(){c.isLoading=!1})):(angular.forEach(a,function(e){i(e)}),!1))},n.$on("row-selected",function(e,t){t?c.hasSelected++:c.hasSelected>0&&c.hasSelected--}),this.updateRow=function(t,n,a){return!(a&&!confirm(a))&&(t.isLoading=!0,e.post(n).then(function(e){t.isLoading=!1,e&&e.model&&angular.extend(t,e.model)},function(){t.isLoading=!1}),!1)},this.updateSelected=function(t,n){if(n&&!confirm(n))return!1;var a=this.getSelected();return!!a.length&&(c.isLoading=!0,void e.post(t,{id:r(a)}).then(function(e){e&&e.models&&angular.forEach(a,function(t){"undefined"!=typeof e.models[t[c.idKey]]&&angular.extend(t,e.models[t[c.idKey]])}),c.isLoading=!1},function(){c.isLoading=!1}))}}]),adminDirectives.directive("stWatchQuery",[function(){return{restrict:"A",require:"^stTable",scope:{mkWatchQuery:"="},link:function(e,t,n,a){e.$watch("stWatchQuery",function(e){a.search(e)})}}}]),adminDirectives.directive("stSelectRow",[function(){return{restrict:"EA",template:'<span class="text-muted glyphicon glyphicon-unchecked st-chk"></span>',scope:{row:"=stSelectRow"},link:function(e,t){return!e.row.non_selectable&&(t.on("click",function(t){t.preventDefault(),e.$apply(function(){e.row.isSelected=!e.row.isSelected})}),void e.$watch("row.isSelected",function(n,a){t.parent().toggleClass("st-selected info",1==n),t.children().toggleClass("text-muted glyphicon-unchecked",n!==!0).toggleClass("glyphicon-check",1==n),e.$emit("row-selected",n)}))}}}]),adminDirectives.directive("stSelectAllRows",[function(){return{restrict:"EA",template:'<span class="text-muted glyphicon glyphicon-unchecked st-chk"></span>',scope:{all:"=stSelectAllRows"},link:function(e,t){t.on("click",function(t){t.preventDefault(),e.$apply(function(){e.isAllSelected=!e.isAllSelected||!1})}),e.$watch("isAllSelected",function(){e.all&&(e.all.forEach(function(t){t.non_selectable||(t.isSelected=e.isAllSelected||!1)}),t.children().toggleClass("text-muted glyphicon-unchecked",e.isAllSelected!==!0).toggleClass("glyphicon-check",1==e.isAllSelected))}),e.$watch("all",function(t,n){e.isAllSelected=!1})}}}])}(window.angular);